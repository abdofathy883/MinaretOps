name: Deploy_API

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

    - name: Build and publish
      run: dotnet publish ClientAPI/ClientAPI.csproj -c Release -o ./publish-output

    - name: Show build output (debug)
      run: |
        echo "Built at $(date -Iseconds)"
        echo "Commit: ${{ github.sha }} | Ref: ${{ github.ref }}"
        ls -la ./publish-output/ | head -30

    - name: Deploy build output to server
      run: |
        rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
          ./publish-output/ \
          ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/var/www/minaretopsapi/published/

    - name: Verify on server (debug)
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} \
          "echo '--- /var/www/minaretopsapi/published/ ---'; ls -la /var/www/minaretopsapi/published/ | head -20; echo '--- ClientAPI.dll mtime ---'; stat -c '%y %n' /var/www/minaretopsapi/published/ClientAPI.dll 2>/dev/null || true"

    - name: Restart service on server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} \
          "systemctl daemon-reload && systemctl restart minaretapi.service && systemctl status minaretapi.service --no-pager -l"